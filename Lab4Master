% lab4_master.m
% Master file for EME 171 Lab 4: Surge Tank Simulation

clear; clc; close all;

% Global parameters
global rho g Ap Cf L Q0_initial At_start

% Constants
rho = 1000;            % Water density (kg/m^3)
g = 9.81;              % Gravity (m/s^2)
Ap = 0.1;              % Pipe area (m^2)
Cf = 49000;            % Fluid resistance constant (kg/m^7)
L = 50;                % Pipe section lengths (m)
Q0_initial = 1.5;      % Initial turbine flow (m^3/s)

% Time control parameters
t_start = 0;           % Start time (s)
t_end = 5;             % End time (s)
time_step = 0.001;     % Time step (s)
tspan = t_start:time_step:t_end;

% Initial steady-state tank area and other variables
At_start = 0.2; % Starting tank area (m^2)

% Calculate initial conditions
p1_initial = rho * Q0_initial * Ap;
p2_initial = rho * Q0_initial * Ap;
V1_initial = Q0_initial * L / Ap; % Initial tank 1 volume
V2_initial = Q0_initial * L / Ap; % Initial tank 2 volume
initial_conditions = [p1_initial; p2_initial; V1_initial; V2_initial];

% Run simulation
[time, state] = ode45(@equations_of_motion, tspan, initial_conditions);

% Post-process and analyze results
analyze_results(time, state);
